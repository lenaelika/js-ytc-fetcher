"use strict";var params,timer=null,srcRegex={channel:new RegExp("^[a-z0-9_-]{24}$","i"),video:new RegExp("^[a-z0-9_-]{11}$","i")};function storeParams(){localStorage.setItem("requestParams",JSON.stringify(params))}function showRequestForm(){$("#request-form").removeClass("was-validated"),$("#request").removeClass("d-none")}function validateForm(e){var a=$("#request-form").addClass("was-validated").get(0).checkValidity();return a||(e.preventDefault(),e.stopPropagation()),a}function renew(){params={key:params.key||""},storeParams(),window.location.href="./index.html"}function stop(){null!==timer&&clearInterval(timer),$(this).addClass("d-none"),$("#update").addClass("d-none"),showRequestForm()}function loadClient(){gapi.load("client",{callback:()=>{gapi.client.init({apiKey:params.key,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"]}).then(()=>{srcRegex.channel.test(params.id)?(params.channelId=params.id,params.username=null,loadChannelVideo()):srcRegex.video.test(params.id)?(params.videoId=params.id,loadVideo()):(params.channelId=null,params.username=params.id,loadChannelVideo())})},onerror:e=>{showError("Failed to load client",e)}})}function loadChannelVideo(){gapi.client.youtube.channels.list({part:"contentDetails",id:params.channelId,forUsername:params.username}).then(e=>{if(e.result.items.length<1)showWarning("Channel not found");else{var a=e.result.items[0].contentDetails.relatedPlaylists.uploads;a?gapi.client.youtube.playlistItems.list({part:"contentDetails",playlistId:a,maxResults:1}).then(e=>{e.result.items.length<1?showWarning("Uploads list is empty"):(params.videoId=e.result.items[0].contentDetails.videoId,loadVideo())},e=>{showError("Failed to load uploads list",e)}):showWarning("Channel uploads not found")}},e=>{showError("Failed to load channel info",e)}).then()}function loadVideo(){return gapi.client.youtube.videos.list({part:"snippet,statistics",id:params.videoId}).then(e=>{if(e.result.items.length<1)showWarning("Video not found");else{$("#request").addClass("d-none");var a=e.result.items[0],t="https://www.youtube.com/watch?v="+a.id;$("#videoTitle").html("<a href='"+t+"' target='_blank'>"+a.snippet.title+"</a>"),$("#videoStats").text(formatDate(a.snippet.publishedAt)[0]+" "+a.statistics.viewCount+" views, "+a.statistics.likeCount+" likes, "+a.statistics.commentCount+" comments"),$("#list").removeClass("d-none"),params.channelId=a.snippet.channelId,storeParams(),loadComments()}},e=>{showError("Failed to load video info",e)}),!1}function loadComments(){gapi.client.youtube.commentThreads.list({part:"snippet",videoId:params.videoId,maxResults:params.limit||20}).then(e=>{if(e.result.items.length<1)showWarning("Comments not found");else{var a=$("<div id='comments'>");e.result.items.forEach(e=>{a.append(makeComment(e.id,e.snippet.topLevelComment.snippet,e.snippet.totalReplyCount))}),setTimeout(()=>{$("#comments").replaceWith(a);var e=$("#update"),t=$("#refresh"),s=$("#stop"),n=params.update||0;if(n<1)e.addClass("d-none"),t.removeClass("d-none"),s.text("edit request").removeClass("d-none");else{t.addClass("d-none");var r=e.find("span").text(n);timer=setInterval(()=>{r.text(n--),0===n&&(clearInterval(timer),timer=null,loadComments())},1e3),s.text("stop & edit request").removeClass("d-none"),e.removeClass("d-none")}},500)}},e=>{showError("Failed to load comments",e)})}function makeComment(e,a,t){var s=void 0!==a.authorChannelId&&a.authorChannelId.value===params.channelId,n=$("#comment-template > div").clone(),r=n.find(".comment-username").text(a.authorDisplayName);s&&r.addClass("text-danger");var o=formatDate(a.publishedAt);n.find(".comment-date").text(o[0]);var i=n.find(".comment-text");i.html(a.textDisplay),o[1]&&i.addClass("text-success");var l=n.find(".comment-reply-count");if(t>0){if(l.find("a").attr("href","#r-"+e).text(t),loadReplies(e,n),s){var d=$("#comment-card-template > div").clone();return d.find("div").append(n.removeClass()),d}}else l.remove();return n}function formatDate(e){var a=new Date(e),t=(Date.now()-a.getTime())/6e4;return t<60?[Math.ceil(t)+"m ago",t<=params.recent]:(t/=60)<24?[Math.ceil(t)+"h ago",!1]:[Math.ceil(t/24)+"d ago",!1]}function loadReplies(e,a){gapi.client.youtube.comments.list({part:"snippet",parentId:e,maxResults:params.limit||10}).then(t=>{if(t.result.items.length<1)showWarning("Replies not found");else{var s=$("<div id='r-"+e+"' class='collapse show'>");t.result.items.forEach(e=>{var a=makeComment(!1,e.snippet,0);s.append(a.addClass("ml-3"))}),a.append(s)}},e=>{showError("Failed to load replies",e)})}function showWarning(e){var a=$("#alert-template div").clone().addClass("alert-warning");a.prepend(e),$("#alert-list").append(a),showRequestForm()}function showError(e,a){void 0!==a&&(console.error(a),void 0!==a.result&&(a=a.result),void 0!==a.error&&(void 0!==(a=a.error).errors&&a.errors.length>0?e+=":<br>"+(a=a.errors[0]).reason+": "+a.message:e+=":<br>"+a.message));var t=$("#alert-template div").clone().addClass("alert-danger");t.prepend(e),$("#alert-list").append(t),showRequestForm()}$(function(){window.onerror=showError;var e=$("#request-form");try{params=JSON.parse(localStorage.getItem("requestParams"))}catch(e){}"object"==typeof params&&null!==params||(params={});var a={};window.location.search.replace(/[?&]+(\w+)=([^?&#]*)/g,(e,t,s)=>{a[t]=s.trim()});var t=!0;e.find("input").each((e,s)=>{s.name in a?params[s.name]=a[s.name]:t=!1,s.name in params&&(s.value=params[s.name])}),storeParams(),$("#request-from").submit(validateForm),$("#stop").click(stop),$("#renew").click(renew),$("#refresh").click(loadVideo),t?loadClient():showRequestForm()});