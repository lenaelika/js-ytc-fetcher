"use strict";var params,timer=null,srcRegex={channel:new RegExp("^[a-z0-9_-]{24}$","i"),video:new RegExp("^[a-z0-9_-]{11}$","i")};function storeParams(){localStorage.setItem("requestParams",JSON.stringify(params))}function showRequestForm(){$("#request-form").removeClass("was-validated"),$("#request").removeClass("d-none")}function validateForm(e){var t=$("#request-form").addClass("was-validated").get(0).checkValidity();return t||(e.preventDefault(),e.stopPropagation()),t}function renew(){params={key:params.key||""},storeParams(),window.location.href="./index.html"}function stop(){null!==timer&&clearInterval(timer),$(this).addClass("d-none"),$("#update").addClass("d-none"),showRequestForm()}function loadClient(){gapi.load("client",{callback:()=>{gapi.client.init({apiKey:params.key,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"]}).then(()=>{srcRegex.channel.test(params.id)?(params.channelId=params.id,params.username=null,loadChannelVideo()):srcRegex.video.test(params.id)?(params.videoId=params.id,loadVideo()):(params.channelId=null,params.username=params.id,loadChannelVideo())})},onerror:e=>{showError("Failed to load client",e)}})}function loadChannelVideo(){gapi.client.youtube.channels.list({part:"contentDetails",id:params.channelId,forUsername:params.username}).then(e=>{if(e.result.items.length<1)showWarning("Channel not found");else{var t=e.result.items[0].contentDetails.relatedPlaylists.uploads;t?gapi.client.youtube.playlistItems.list({part:"contentDetails",playlistId:t,maxResults:1}).then(e=>{e.result.items.length<1?showWarning("Uploads list is empty"):(params.videoId=e.result.items[0].contentDetails.videoId,loadVideo())},e=>{showError("Failed to load uploads list",e)}):showWarning("Channel uploads not found")}},e=>{showError("Failed to load channel info",e)}).then()}function loadVideo(){return gapi.client.youtube.videos.list({part:"snippet,statistics",id:params.videoId}).then(e=>{if(e.result.items.length<1)showWarning("Video not found");else{$("#request").addClass("d-none");var t=e.result.items[0],a="https://www.youtube.com/watch?v="+t.id;$("#videoTitle").html("<a href='"+a+"' target='_blank'>"+t.snippet.title+"</a>"),$("#videoStats").text(formatDate(t.snippet.publishedAt)[0]+" "+t.statistics.viewCount+" views, "+t.statistics.likeCount+" likes, "+t.statistics.commentCount+" comments"),$("#list").removeClass("d-none"),params.channelId=t.snippet.channelId,storeParams(),document.title=t.snippet.channelTitle+" - YTC Fetcher",loadComments()}},e=>{showError("Failed to load video info",e)}),!1}function loadComments(){gapi.client.youtube.commentThreads.list({part:"snippet",videoId:params.videoId,maxResults:params.limit||20}).then(e=>{if(e.result.items.length<1)showWarning("Comments not found");else{var t=$("<div id='comments'>");e.result.items.forEach(e=>{t.append(makeComment(e.id,e.snippet.topLevelComment.snippet,e.snippet.totalReplyCount))}),setTimeout(()=>{$("#comments").replaceWith(t);var e=$("#update"),a=$("#refresh"),s=$("#stop"),n=params.update||0;if(n<1)e.addClass("d-none"),a.removeClass("d-none"),s.text("edit request").removeClass("d-none");else{a.addClass("d-none");var r=e.find("span").text(n);timer=setInterval(()=>{r.text(n--),0===n&&(clearInterval(timer),timer=null,loadComments())},1e3),s.text("stop & edit request").removeClass("d-none"),e.removeClass("d-none")}},500)}},e=>{showError("Failed to load comments",e)})}function makeComment(e,t,a){var s=void 0!==t.authorChannelId&&t.authorChannelId.value===params.channelId,n=$("#comment-template > div").clone(),r=n.find(".comment-username").text(t.authorDisplayName);s&&r.addClass("text-danger");var o=formatDate(t.publishedAt);n.find(".comment-date").text(o[0]);var i=n.find(".comment-text");i.html(t.textDisplay),o[1]&&i.addClass("text-success");var l=n.find(".comment-reply-count");if(a>0){if(l.find("a").attr("href","#r-"+e).text(a),loadReplies(e,n),s){var d=$("#comment-card-template > div").clone();return d.find("div").append(n.removeClass()),d}}else l.remove();return n}function formatDate(e){var t=new Date(e),a=(Date.now()-t.getTime())/6e4;return a<60?[Math.ceil(a)+"m ago",a<=params.recent]:(a/=60)<24?[Math.ceil(a)+"h ago",!1]:[Math.ceil(a/24)+"d ago",!1]}function loadReplies(e,t){gapi.client.youtube.comments.list({part:"snippet",parentId:e,maxResults:params.limit||10}).then(a=>{if(a.result.items.length<1)showWarning("Replies not found");else{var s=$("<div id='r-"+e+"' class='collapse show'>");a.result.items.forEach(e=>{var t=makeComment(!1,e.snippet,0);s.append(t.addClass("ml-3"))}),t.append(s)}},e=>{showError("Failed to load replies",e)})}function showWarning(e){var t=$("#alert-template div").clone().addClass("alert-warning");t.prepend(e),$("#alert-list").append(t),showRequestForm()}function showError(e,t){void 0!==t&&(console.error(t),void 0!==t.result&&(t=t.result),void 0!==t.error&&(void 0!==(t=t.error).errors&&t.errors.length>0?e+=":<br>"+(t=t.errors[0]).reason+": "+t.message:e+=":<br>"+t.message));var a=$("#alert-template div").clone().addClass("alert-danger");a.prepend(e),$("#alert-list").append(a),showRequestForm()}$(function(){window.onerror=showError;var e=$("#request-form");try{params=JSON.parse(localStorage.getItem("requestParams"))}catch(e){}"object"==typeof params&&null!==params||(params={});var t={};window.location.search.replace(/[?&]+(\w+)=([^?&#]*)/g,(e,a,s)=>{t[a]=s.trim()});var a=!0;e.find("input").each((e,s)=>{s.name in t?params[s.name]=t[s.name]:a=!1,s.name in params&&(s.value=params[s.name])}),storeParams(),$("#request-from").submit(validateForm),$("#stop").click(stop),$("#renew").click(renew),$("#refresh").click(loadVideo),a?loadClient():showRequestForm()});